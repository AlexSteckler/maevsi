<template>
  <Loader :api="api">
    <div class="flex flex-col gap-4">
      <ScrollContainer
        v-if="event && invitations?.length"
        :has-next-page="api.data.allInvitations?.pageInfo.hasNextPage"
        @loadMore="loadMore"
      >
        <table class="border border-neutral-300 dark:border-neutral-600">
          <thead
            class="sticky top-0 z-10 bg-background-bright dark:bg-background-dark"
          >
            <tr>
              <th scope="col">
                {{ $t('contact') }}
              </th>
              <th />
            </tr>
          </thead>
          <tbody class="divide-y divide-neutral-300 dark:divide-neutral-600">
            <tr
              v-for="invitation in invitations"
              :key="invitation.uuid"
              :class="{
                'animate-pulse': pending.deletions.includes(invitation.uuid),
              }"
            >
              <td class="max-w-0">
                <ContactPreview
                  :contact="invitation.contactByContactId"
                  :feedback="invitation.feedback"
                />
              </td>
              <td class="max-w-0">
                <div
                  class="flex items-center justify-evenly gap-4 text-text-dark dark:text-text-bright"
                >
                  <ButtonIcon
                    :aria-label="
                      invitation.contactByContactId?.accountUsername ||
                      invitation.contactByContactId?.emailAddress
                        ? $t('invitationSend')
                        : $t('disabledReasonEmailAddressNone')
                    "
                    class="hidden md:block"
                    :disabled="
                      (!invitation.contactByContactId?.accountUsername &&
                        !invitation.contactByContactId?.emailAddress) ||
                      pending.sends.includes(invitation.uuid)
                    "
                    @click="send(invitation)"
                  >
                    <IconPaperPlane />
                  </ButtonIcon>
                  <ButtonIcon
                    :aria-label="$t('invitationLink')"
                    class="hidden md:block"
                    @click="copyLink(invitation)"
                  >
                    <IconLink />
                  </ButtonIcon>
                  <DropDown>
                    <ButtonIcon :aria-label="$t('globalShowMore')">
                      <IconDotsVertical />
                    </ButtonIcon>
                    <template slot="content">
                      <ButtonIcon
                        :aria-label="
                          invitation.contactByContactId?.accountUsername ||
                          invitation.contactByContactId?.emailAddress
                            ? $t('invitationSend')
                            : $t('disabledReasonEmailAddressNone')
                        "
                        class="block md:hidden"
                        :disabled="
                          (!invitation.contactByContactId?.accountUsername &&
                            !invitation.contactByContactId?.emailAddress) ||
                          pending.sends.includes(invitation.uuid)
                        "
                        @click="send(invitation)"
                      >
                        <IconPaperPlane />
                        {{
                          invitation.contactByContactId?.accountUsername ||
                          invitation.contactByContactId?.emailAddress
                            ? $t('invitationSend')
                            : $t('disabledReasonEmailAddressNone')
                        }}
                      </ButtonIcon>
                      <ButtonIcon
                        :aria-label="$t('invitationLink')"
                        class="block md:hidden"
                        @click="copyLink(invitation)"
                      >
                        <IconLink />
                        {{ $t('invitationLink') }}
                      </ButtonIcon>
                      <ButtonIcon
                        :aria-label="$t('invitationView')"
                        @click="
                          $router.push({
                            path: localePath(
                              `/event/${event.authorUsername}/${event.slug}`
                            ),
                            query: { ic: invitation.uuid },
                          })
                        "
                      >
                        <IconEye />
                        {{ $t('invitationView') }}
                      </ButtonIcon>
                      <ButtonIcon
                        :aria-label="$t('invitationDelete')"
                        :disabled="pending.deletions.includes(invitation.uuid)"
                        @click="delete_(invitation.uuid)"
                      >
                        <IconTrash />
                        {{ $t('invitationDelete') }}
                      </ButtonIcon>
                    </template>
                  </DropDown>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </ScrollContainer>
      <div v-else class="flex flex-col items-center gap-2">
        {{ $t('invitationNone') }}
        <FormInputStateInfo>
          {{ $t('hintInviteSelf') }}
        </FormInputStateInfo>
      </div>
      <div class="flex flex-col items-center gap-1">
        <ButtonColored
          :aria-label="$t('invitationAdd')"
          :disabled="
            event.inviteeCountMaximum && api.data.allInvitations?.totalCount
              ? api.data.allInvitations.totalCount >= event.inviteeCountMaximum
              : false
          "
          @click="add()"
        >
          {{ $t('invitationAdd') }}
          <template slot="prefix">
            <IconPlus />
          </template>
        </ButtonColored>
        <p class="text-center text-gray-500 dark:text-gray-400">
          {{
            $t('invitationsUsed', {
              amountCurrent: api.data.allInvitations?.totalCount,
              amountMaximum: event.inviteeCountMaximum || 'âˆž',
            })
          }}
        </p>
      </div>
      <div v-if="api.data.allInvitations?.totalCount">
        <h2>
          {{ $t('feedback') }}
        </h2>
        <div class="m-auto w-3/4 sm:w-1/2 xl:w-1/3 2xl:w-1/4">
          <!-- https://github.com/reg-viz/storycap/issues/501 -->
          <Doughnut
            v-if="!$config.STORYBOOK"
            ref="doughnut"
            :chart-data="dataComputed"
            :chart-options="options"
          />
        </div>
      </div>
      <Modal id="ModalInvitation">
        <FormInvitation :event="event" @submitSuccess="onSubmitSuccess" />
        <template slot="header">
          {{ $t('contactSelect') }}
        </template>
        <div slot="footer" />
      </Modal>
    </div>
  </Loader>
</template>

<script lang="ts">
import {
  ArcElement,
  CategoryScale,
  Chart,
  DoughnutController,
  Legend,
  LinearScale,
  Title,
  Tooltip,
} from 'chart.js'
import consola from 'consola'
import Swal from 'sweetalert2'
import { Doughnut } from 'vue-chartjs/legacy'
import { useI18n } from 'vue-i18n-composable'

import {
  computed,
  defineComponent,
  onMounted,
  PropType,
  reactive,
  ref,
  useNuxtApp,
  watch,
} from '#app'
import { copyText, getApiMeta } from '~/plugins/util/util'
import { Invitation } from '~/types/invitation'
import { ITEMS_PER_PAGE_LARGE } from '~/plugins/util/constants'
import {
  Event,
  useAllInvitationsQuery,
  useDeleteInvitationByUuidMutation,
  useInviteMutation,
} from '~/gql/generated'

Chart.register(
  ArcElement,
  CategoryScale,
  LinearScale,
  DoughnutController,
  Title,
  Tooltip,
  Legend
)

export default defineComponent({
  components: {
    Doughnut,
  },
  props: {
    event: {
      required: true,
      type: Object as PropType<Event>,
    },
  },
  setup(props) {
    const { $colorMode, $i18n, $store, localePath } = useNuxtApp()
    const { t } = useI18n()
    const deleteInvitationByUuidMutation = useDeleteInvitationByUuidMutation()
    const inviteMutation = useInviteMutation()

    const refs = {
      apiContactsAfter: ref<string>(),
      doughnut: ref(),
    }
    const invitationsQuery = useAllInvitationsQuery({
      variables: {
        after: refs.apiContactsAfter,
        eventId: +props.event.id,
        first: ITEMS_PER_PAGE_LARGE,
      },
    })

    const apiData = {
      api: computed(() => {
        return {
          data: {
            ...invitationsQuery.data.value,
          },
          ...getApiMeta([
            deleteInvitationByUuidMutation,
            inviteMutation,
            invitationsQuery,
          ]),
        }
      }),
      invitations: computed(
        () => invitationsQuery.data.value?.allInvitations?.nodes
      ),
    }
    const data = reactive({
      options: {
        plugins: {
          legend: {
            labels: {
              font: {
                fontFamily:
                  'Manrope, ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"',
                size: 16,
              },
            },
            onClick: null,
          },
        },
      },
      pending: {
        deletions: [] as string[],
        edits: [] as string[],
        sends: [] as string[],
      },
    })
    const methods = {
      add() {
        $store.commit('modalAdd', { id: 'ModalInvitation' })
      },
      copyLink(invitation: Invitation): void {
        if (!process.browser) return

        copyText(
          `${window.location.origin}${localePath(`/task/event/unlock`)}?ic=${
            invitation.uuid
          }`
        ).then(() => {
          Swal.fire({
            icon: 'success',
            text: t('copySuccess') as string,
            timer: 3000,
            timerProgressBar: true,
            title: t('copied'),
          })
        })
      },
      async delete_(uuid: string) {
        data.pending.deletions.push(uuid)
        apiData.api.value.errors = []

        const result = await deleteInvitationByUuidMutation.executeMutation({
          uuid,
        })

        data.pending.deletions.splice(data.pending.deletions.indexOf(uuid), 1)

        if (result.error) {
          apiData.api.value.errors.push(result.error)
          consola.error(result.error)
        }

        // if (!result.data) {
        //   return
        // }
        // TODO: cache update (allInvitations)
      },
      loadMore() {},
      async send(invitation: any) {
        data.pending.sends.push(invitation.uuid)
        apiData.api.value.errors = []

        const result = await inviteMutation.executeMutation({
          invitationId: invitation.id,
          language: $i18n.locale,
        })

        data.pending.sends.splice(
          data.pending.sends.indexOf(invitation.uuid),
          1
        )

        if (result.error) {
          apiData.api.value.errors.push(result.error)
          consola.error(result.error)
        }

        if (!result.data) {
          return
        }

        Swal.fire({
          icon: 'success',
          text: t('sendSuccess') as string,
          timer: 3000,
          timerProgressBar: true,
          title: t('sent'),
        })
        // TODO: cache update (allInvitations)
      },
      onSubmitSuccess() {
        $store.commit('modalRemove', 'ModalInvitation')
        // TODO: cache update (allInvitations)
      },
    }
    const computations = {
      dataComputed: computed(() => {
        const datasetData = [0, 0, 0]

        if (apiData.invitations.value) {
          for (const invitation of apiData.invitations.value) {
            switch (invitation.feedback) {
              case 'ACCEPTED':
                datasetData[0] += 1
                break
              case 'CANCELED':
                datasetData[1] = datasetData[1] + 1
                break
              case null:
                datasetData[2] = datasetData[2] + 1
                break
              default:
                consola.error('Unexpected invitation type.')
            }
          }
        }

        return {
          labels: [t('accepted'), t('canceled'), t('noFeedback')],
          datasets: [
            {
              data: datasetData,
              backgroundColor: ['#00FF00', '#FF0000', '#888888'],
            },
          ],
        }
      }),
    }

    onMounted(() => {
      Chart.defaults.color = () =>
        $colorMode.value === 'dark' ? '#fff' : '#000'
    })

    watch(
      $colorMode,
      (_currentValue, _oldValue) => {
        refs.doughnut.value.getCurrentChart()?.update()
      },
      { deep: true }
    )

    watch(invitationsQuery.error, (currentValue, _oldValue) => {
      if (currentValue) consola.error(currentValue)
    })

    return {
      ...apiData,
      ...refs,
      ...data,
      ...methods,
      ...computations,
    }
  },
})
</script>

<i18n lang="yml">
de:
  accepted: akzeptiert
  canceled: abgelehnt
  contact: Kontakt
  contactSelect: Kontakt auswÃ¤hlen
  copied: Kopiert
  copySuccess: Der Einladungslink wurde in die Zwischenablage kopiert.
  disabledReasonEmailAddressNone: Diesem Kontakt fehlt eine E-Mail-Adresse.
  feedback: RÃ¼ckmeldungen
  hintInviteSelf: 'Tipp: du kannst dich auch zuerst selbst einladen'
  invitationAdd: GÃ¤ste hinzufÃ¼gen
  invitationDelete: Einladung lÃ¶schen
  invitationLink: Einladungslink kopieren
  invitationNone: Es wurde noch kein Gast hinzugefÃ¼gt ðŸ˜•
  invitationSend: Einladung versenden
  invitationView: Einladung anzeigen
  invitationsUsed: 'Einladungen benutzt: {amountCurrent} / {amountMaximum}'
  noFeedback: keine RÃ¼ckmeldung
  postgresP0002: Die Einladung konnte nicht versandt werden! MÃ¶glicherweise hast du aktuell keinen Zugriff auf die notwendigen Daten. Versuche die Seite neu zu laden.
  sendSuccess: Die Einladung wurde erfolgreich per E-Mail versandt.
  sent: Gesendet!
en:
  accepted: accepted
  canceled: declined
  contact: Contact
  contactSelect: Select Contact
  copied: Copied
  copySuccess: The invitation link was copied to the clipboard.
  disabledReasonEmailAddressNone: This contact is missing an email address.
  feedback: Invitation responses
  hintInviteSelf: 'Hint: you can also invite yourself first'
  invitationAdd: Add guests
  invitationDelete: Delete invitation
  invitationLink: Copy invitation link
  invitationNone: No guest has been added yet ðŸ˜•
  invitationSend: Send invitation
  invitationView: View invitation
  invitationsUsed: 'Invitations used: {amountCurrent} / {amountMaximum}'
  noFeedback: no response
  postgresP0002: The invitation could not be sent! You may not currently have access to the necessary data. Try to reload the page.
  sendSuccess: The invitation was successfully sent by email.
  sent: Sent!
</i18n>
